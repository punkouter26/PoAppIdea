# GitHub Actions workflow for building and deploying PoAppIdea to Azure App Service
# Triggers on push to master branch

name: Build and Deploy to Azure

on:
  push:
    branches:
      - master
  workflow_dispatch: # Allow manual trigger

env:
  DOTNET_VERSION: '10.0.x'
  AZURE_WEBAPP_NAME: poappidea-web
  AZURE_WEBAPP_PACKAGE_PATH: './src/PoAppIdea.Web/publish'

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore ./src/PoAppIdea.Web/PoAppIdea.Web.csproj

      - name: Build
        run: dotnet build ./src/PoAppIdea.Web/PoAppIdea.Web.csproj --configuration Release --no-restore

      - name: Publish
        run: dotnet publish ./src/PoAppIdea.Web/PoAppIdea.Web.csproj --configuration Release --no-build --output ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

      - name: Wait for app startup
        run: sleep 30

      - name: Health Check Gate
        run: |
          echo "Checking health endpoint..."
          HEALTH_URL="https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/health"
          
          for i in {1..5}; do
            RESPONSE=$(curl -s -w "\n%{http_code}" "$HEALTH_URL")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | head -n-1)
            
            echo "Attempt $i: HTTP $HTTP_CODE"
            echo "$BODY"
            
            if [ "$HTTP_CODE" = "200" ]; then
              STATUS=$(echo "$BODY" | jq -r '.status // empty')
              if [ "$STATUS" = "Healthy" ]; then
                echo "✅ Health check passed!"
                exit 0
              fi
            fi
            
            if [ $i -lt 5 ]; then
              echo "Retrying in 10 seconds..."
              sleep 10
            fi
          done
          
          echo "❌ Health check failed after 5 attempts"
          exit 1

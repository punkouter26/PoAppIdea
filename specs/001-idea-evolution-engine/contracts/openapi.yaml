openapi: 3.1.0
info:
  title: PoAppIdea API
  description: Self-Evolving Ideation Engine - API for idea generation, evolution, and artifact production
  version: 1.0.0
  contact:
    name: PoAppIdea Team
servers:
  - url: https://localhost:5001
    description: Local development (HTTPS)
  - url: http://localhost:5000
    description: Local development (HTTP)
  - url: https://poappidea.azurewebsites.net
    description: Production (Azure App Service)

tags:
  - name: Session
    description: Session lifecycle management
  - name: Spark
    description: Phase 1 - Idea discovery and swiping
  - name: Mutation
    description: Phase 2 - Directed evolution
  - name: FeatureExpansion
    description: Phase 3 - Service integrations
  - name: Synthesis
    description: Idea merging and selection
  - name: Refinement
    description: Phases 4-5 - PM/Architect questions
  - name: Visual
    description: Phase 6 - DALL-E mockups
  - name: Artifacts
    description: Final deliverable generation
  - name: Personality
    description: Product Personality profile
  - name: Gallery
    description: Public gallery browsing and publishing
  - name: Health
    description: System health checks

paths:
  /health:
    get:
      tags: [Health]
      summary: Health check endpoint
      description: Checks connectivity to Azure Table Storage, Blob Storage, and Azure OpenAI
      operationId: getHealth
      responses:
        '200':
          description: All systems healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: One or more systems unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /api/sessions:
    post:
      tags: [Session]
      summary: Start a new ideation session
      operationId: startSession
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StartSessionRequest'
      responses:
        '201':
          description: Session created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

    get:
      tags: [Session]
      summary: List user's sessions
      operationId: listSessions
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/SessionStatus'
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
      responses:
        '200':
          description: List of sessions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SessionSummary'

  /api/sessions/{sessionId}:
    get:
      tags: [Session]
      summary: Get session details
      operationId: getSession
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: Session details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/sessions/{sessionId}/ideas:
    post:
      tags: [Spark]
      summary: Generate next batch of ideas
      description: Generates 10 ideas for the current batch, incorporating learning from previous swipes
      operationId: generateIdeas
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: Batch of ideas generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IdeaBatchResponse'
        '400':
          description: Session not in Phase 1 or batch limit reached
        '404':
          $ref: '#/components/responses/NotFound'

  /api/sessions/{sessionId}/swipes:
    post:
      tags: [Spark]
      summary: Record a swipe on an idea
      operationId: recordSwipe
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RecordSwipeRequest'
      responses:
        '201':
          description: Swipe recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SwipeResponse'
        '400':
          description: Invalid swipe data or idea already swiped

  /api/sessions/{sessionId}/mutations:
    post:
      tags: [Mutation]
      summary: Generate mutations for top ideas
      description: Generates 50 mutations (10 per top 5 idea) using Crossover and Repurposing
      operationId: generateMutations
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: Mutations generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MutationBatchResponse'
        '400':
          description: Session not ready for mutation phase

    get:
      tags: [Mutation]
      summary: Get mutations for rating
      operationId: getMutations
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: List of mutations
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MutationResponse'

  /api/sessions/{sessionId}/mutations/{mutationId}/rate:
    post:
      tags: [Mutation]
      summary: Rate a mutation
      operationId: rateMutation
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
        - $ref: '#/components/parameters/MutationId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RatingRequest'
      responses:
        '200':
          description: Rating recorded

  /api/sessions/{sessionId}/feature-variations:
    post:
      tags: [FeatureExpansion]
      summary: Generate feature variations
      description: Generates 5 feature variations per top 10 mutation
      operationId: generateFeatureVariations
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: Feature variations generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeatureVariationBatchResponse'

  /api/sessions/{sessionId}/feature-variations/{variationId}/rate:
    post:
      tags: [FeatureExpansion]
      summary: Rate a feature variation
      operationId: rateFeatureVariation
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
        - name: variationId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RatingRequest'
      responses:
        '200':
          description: Rating recorded

  /api/sessions/{sessionId}/submit:
    post:
      tags: [Synthesis]
      summary: Submit selected ideas for synthesis
      operationId: submitSelection
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubmitSelectionRequest'
      responses:
        '200':
          description: Selection submitted, synthesis performed if multiple ideas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SynthesisResponse'

  /api/sessions/{sessionId}/refinement/questions:
    get:
      tags: [Refinement]
      summary: Get current phase questions
      operationId: getRefinementQuestions
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: List of 10 questions for current phase
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RefinementQuestionsResponse'

  /api/sessions/{sessionId}/refinement/answers:
    post:
      tags: [Refinement]
      summary: Submit answers to refinement questions
      operationId: submitRefinementAnswers
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubmitAnswersRequest'
      responses:
        '200':
          description: Answers recorded, phase advanced
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RefinementProgressResponse'

  /api/sessions/{sessionId}/visuals:
    post:
      tags: [Visual]
      summary: Generate visual mockups
      description: Triggers DALL-E to generate 10 mood boards/mockups
      operationId: generateVisuals
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '202':
          description: Visual generation started (async)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VisualGenerationStatus'

    get:
      tags: [Visual]
      summary: Get generated visuals
      operationId: getVisuals
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: List of generated visuals
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/VisualAssetResponse'

  /api/sessions/{sessionId}/visuals/{assetId}/select:
    post:
      tags: [Visual]
      summary: Select a visual direction
      operationId: selectVisual
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
        - name: assetId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Visual selected

  /api/sessions/{sessionId}/artifacts:
    post:
      tags: [Artifacts]
      summary: Generate final artifacts
      description: Generates PRD, Technical Deep-Dive, and Visual Asset Pack
      operationId: generateArtifacts
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '202':
          description: Artifact generation started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArtifactGenerationStatus'

    get:
      tags: [Artifacts]
      summary: Get generated artifacts
      operationId: getArtifacts
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: List of artifacts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ArtifactResponse'

  /api/personality:
    get:
      tags: [Personality]
      summary: Get user's Product Personality profile
      operationId: getPersonality
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Personality profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PersonalityResponse'

  /api/gallery:
    get:
      tags: [Gallery]
      summary: Browse public gallery
      operationId: browseGallery
      parameters:
        - name: query
          in: query
          schema:
            type: string
        - name: appType
          in: query
          schema:
            $ref: '#/components/schemas/AppType'
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: cursor
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Gallery items
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GalleryResponse'

  /api/gallery/{artifactId}:
    get:
      tags: [Gallery]
      summary: Get public artifact details
      operationId: getGalleryArtifact
      parameters:
        - name: artifactId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Artifact details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArtifactResponse'

  /api/artifacts/{artifactId}/publish:
    post:
      tags: [Gallery]
      summary: Publish artifact to gallery
      operationId: publishArtifact
      security:
        - bearerAuth: []
      parameters:
        - name: artifactId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Artifact published

  /api/gallery/{artifactId}/import:
    post:
      tags: [Gallery]
      summary: Import idea from gallery as session starting point
      operationId: importFromGallery
      security:
        - bearerAuth: []
      parameters:
        - name: artifactId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '201':
          description: New session created from import
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    SessionId:
      name: sessionId
      in: path
      required: true
      schema:
        type: string
        format: uuid
    MutationId:
      name: mutationId
      in: path
      required: true
      schema:
        type: string
        format: uuid

  responses:
    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  schemas:
    # Enums
    AppType:
      type: string
      enum: [Game, Productivity, Mobile, Automation]
    
    SessionStatus:
      type: string
      enum: [InProgress, Completed, Abandoned]
    
    SessionPhase:
      type: string
      enum: [Phase0_Scope, Phase1_Spark, Phase2_Mutation, Phase3_FeatureExpansion, Submission, Phase4_ProductRefinement, Phase5_TechnicalRefinement, Phase6_Visual, Completed]
    
    SwipeDirection:
      type: string
      enum: [Like, Dislike]
    
    MutationType:
      type: string
      enum: [Crossover, Repurposing]
    
    ArtifactType:
      type: string
      enum: [PRD, TechnicalDeepDive, VisualAssetPack]

    # Request/Response Schemas
    StartSessionRequest:
      type: object
      required: [appType, complexityLevel]
      properties:
        appType:
          $ref: '#/components/schemas/AppType'
        complexityLevel:
          type: integer
          minimum: 1
          maximum: 5

    SessionResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        appType:
          $ref: '#/components/schemas/AppType'
        complexityLevel:
          type: integer
        currentPhase:
          $ref: '#/components/schemas/SessionPhase'
        status:
          $ref: '#/components/schemas/SessionStatus'
        createdAt:
          type: string
          format: date-time

    SessionSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        appType:
          $ref: '#/components/schemas/AppType'
        currentPhase:
          $ref: '#/components/schemas/SessionPhase'
        status:
          $ref: '#/components/schemas/SessionStatus'
        createdAt:
          type: string
          format: date-time

    IdeaBatchResponse:
      type: object
      properties:
        batchNumber:
          type: integer
        ideas:
          type: array
          items:
            $ref: '#/components/schemas/IdeaResponse'
        remainingBatches:
          type: integer

    IdeaResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        description:
          type: string
        batchNumber:
          type: integer

    RecordSwipeRequest:
      type: object
      required: [ideaId, direction, durationMs]
      properties:
        ideaId:
          type: string
          format: uuid
        direction:
          $ref: '#/components/schemas/SwipeDirection'
        durationMs:
          type: integer
          minimum: 1

    SwipeResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        speedCategory:
          type: string
          enum: [Fast, Medium, Slow]

    MutationBatchResponse:
      type: object
      properties:
        totalMutations:
          type: integer
        mutations:
          type: array
          items:
            $ref: '#/components/schemas/MutationResponse'

    MutationResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        description:
          type: string
        mutationType:
          $ref: '#/components/schemas/MutationType'
        mutationRationale:
          type: string
        parentIdeaTitles:
          type: array
          items:
            type: string

    RatingRequest:
      type: object
      required: [score]
      properties:
        score:
          type: number
          minimum: 1
          maximum: 5

    FeatureVariationBatchResponse:
      type: object
      properties:
        totalVariations:
          type: integer
        variations:
          type: array
          items:
            $ref: '#/components/schemas/FeatureVariationResponse'

    FeatureVariationResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        mutationId:
          type: string
          format: uuid
        variationTheme:
          type: string
        features:
          type: array
          items:
            $ref: '#/components/schemas/Feature'
        serviceIntegrations:
          type: array
          items:
            type: string

    Feature:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        priority:
          type: string
          enum: [Must, Should, Could, Wont]

    SubmitSelectionRequest:
      type: object
      required: [selectedIdeaIds]
      properties:
        selectedIdeaIds:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          maxItems: 10

    SynthesisResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        mergedTitle:
          type: string
        mergedDescription:
          type: string
        thematicBridge:
          type: string
        retainedElements:
          type: object
          additionalProperties:
            type: array
            items:
              type: string

    RefinementQuestionsResponse:
      type: object
      properties:
        phase:
          type: string
          enum: [Phase4_PM, Phase5_Architect]
        questions:
          type: array
          items:
            $ref: '#/components/schemas/RefinementQuestion'

    RefinementQuestion:
      type: object
      properties:
        questionNumber:
          type: integer
        questionText:
          type: string
        category:
          type: string
        exampleAnswer:
          type: string

    SubmitAnswersRequest:
      type: object
      required: [answers]
      properties:
        answers:
          type: array
          items:
            $ref: '#/components/schemas/AnswerInput'
          minItems: 10
          maxItems: 10

    AnswerInput:
      type: object
      required: [questionNumber, answerText]
      properties:
        questionNumber:
          type: integer
        answerText:
          type: string
          maxLength: 2000

    RefinementProgressResponse:
      type: object
      properties:
        currentPhase:
          $ref: '#/components/schemas/SessionPhase'
        answersRecorded:
          type: integer
        nextPhase:
          $ref: '#/components/schemas/SessionPhase'

    VisualGenerationStatus:
      type: object
      properties:
        status:
          type: string
          enum: [Queued, InProgress, Completed, Failed]
        generatedCount:
          type: integer
        estimatedCompletionSeconds:
          type: integer

    VisualAssetResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        blobUrl:
          type: string
          format: uri
        thumbnailUrl:
          type: string
          format: uri
        styleAttributes:
          $ref: '#/components/schemas/StyleInfo'
        isSelected:
          type: boolean

    StyleInfo:
      type: object
      properties:
        colorPalette:
          type: array
          items:
            type: string
        layoutStyle:
          type: string
        vibe:
          type: string

    ArtifactGenerationStatus:
      type: object
      properties:
        status:
          type: string
          enum: [Queued, InProgress, Completed, Failed]
        artifacts:
          type: array
          items:
            type: string
            enum: [PRD, TechnicalDeepDive, VisualAssetPack]

    ArtifactResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          $ref: '#/components/schemas/ArtifactType'
        title:
          type: string
        content:
          type: string
        blobUrl:
          type: string
          format: uri
        humanReadableSlug:
          type: string
        isPublished:
          type: boolean
        createdAt:
          type: string
          format: date-time

    PersonalityResponse:
      type: object
      properties:
        productBiases:
          type: object
          additionalProperties:
            type: number
        technicalBiases:
          type: object
          additionalProperties:
            type: number
        dislikedPatterns:
          type: array
          items:
            type: string
        totalSessions:
          type: integer

    GalleryResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/GalleryItem'
        nextCursor:
          type: string

    GalleryItem:
      type: object
      properties:
        artifactId:
          type: string
          format: uuid
        title:
          type: string
        appType:
          $ref: '#/components/schemas/AppType'
        authorDisplayName:
          type: string
        publishedAt:
          type: string
          format: date-time
        thumbnailUrl:
          type: string
          format: uri

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [Healthy, Degraded, Unhealthy]
        checks:
          type: array
          items:
            $ref: '#/components/schemas/HealthCheck'

    HealthCheck:
      type: object
      properties:
        name:
          type: string
        status:
          type: string
          enum: [Healthy, Degraded, Unhealthy]
        duration:
          type: string
        description:
          type: string

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        traceId:
          type: string

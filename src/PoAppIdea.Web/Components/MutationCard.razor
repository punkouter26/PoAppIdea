@using PoAppIdea.Shared.Contracts

<RadzenCard class="@CardClass">
    <RadzenStack Gap="0.75rem">
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Start">
            <RadzenText TextStyle="TextStyle.H6" TagName="TagName.H3">
                @Mutation.Title
            </RadzenText>
            <RadzenBadge BadgeStyle="@GetBadgeStyle()" Text="@Mutation.MutationType.ToString()" />
        </RadzenStack>

        <RadzenText TextStyle="TextStyle.Body2">
            @Mutation.Description
        </RadzenText>

        <RadzenCard Style="background: var(--rz-secondary-lighter); padding: 0.75rem;">
            <RadzenStack Gap="0.25rem">
                <RadzenText TextStyle="TextStyle.Caption" Style="font-weight: 600;">
                    <RadzenIcon Icon="auto_fix_high" Style="font-size: 14px; vertical-align: middle;" />
                    Mutation Rationale
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Caption">
                    @Mutation.MutationRationale
                </RadzenText>
            </RadzenStack>
        </RadzenCard>

        @if (IsRating)
        {
            <RadzenStack Gap="0.5rem">
                <RadzenText TextStyle="TextStyle.Caption" Style="font-weight: 600;">Rate this mutation:</RadzenText>
                <RadzenRating @bind-Value="@currentRating" Stars="5" Change="@OnRatingChanged" />
                
                @if (isSaving)
                {
                    <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Small" />
                }
                else if (showSaved)
                {
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-text-success-color">
                        <RadzenIcon Icon="check_circle" Style="font-size: 14px; vertical-align: middle;" />
                        Rating saved!
                    </RadzenText>
                }
            </RadzenStack>
        }
        else
        {
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" class="rz-mt-2">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-text-secondary-color">
                    @($"Parent Ideas: {Mutation.ParentIdeaIds.Count}")
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Caption" class="rz-text-secondary-color">
                    Score: @Mutation.Score.ToString("F1")
                </RadzenText>
            </RadzenStack>
        }
    </RadzenStack>
</RadzenCard>

<style>
    .mutation-card {
        border-left: 4px solid var(--rz-primary);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .mutation-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .mutation-card.rating-mode {
        border-left-color: var(--rz-warning);
    }

    .mutation-card.crossover {
        border-left-color: var(--rz-info);
    }

    .mutation-card.repurposing {
        border-left-color: var(--rz-success);
    }
</style>

@code {
    [Parameter]
    public required MutationDto Mutation { get; set; }

    [Parameter]
    public bool IsRating { get; set; } = false;

    [Parameter]
    public EventCallback<(Guid MutationId, float Score)> OnRated { get; set; }

    private int currentRating = 0;
    private bool isSaving = false;
    private bool showSaved = false;

    protected override void OnParametersSet()
    {
        currentRating = (int)Math.Round(Mutation.Score);
    }

    private BadgeStyle GetBadgeStyle() => Mutation.MutationType switch
    {
        PoAppIdea.Core.Enums.MutationType.Crossover => BadgeStyle.Info,
        PoAppIdea.Core.Enums.MutationType.Repurposing => BadgeStyle.Success,
        _ => BadgeStyle.Secondary
    };

    private string CardClass => IsRating ? "mutation-card rating-mode" : "mutation-card";

    private async Task OnRatingChanged(int value)
    {
        if (value <= 0) return;

        isSaving = true;
        showSaved = false;
        StateHasChanged();

        try
        {
            await OnRated.InvokeAsync((Mutation.Id, value));
            showSaved = true;
        }
        finally
        {
            isSaving = false;
            await Task.Delay(2000);
            showSaved = false;
            StateHasChanged();
        }
    }
}

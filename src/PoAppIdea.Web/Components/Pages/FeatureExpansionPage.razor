@page "/session/{SessionId:guid}/features"
@page "/session/{SessionId:guid}/expand"
@using PoAppIdea.Core.Enums
@using PoAppIdea.Shared.Contracts
@using PoAppIdea.Web.Components.Shared
@using PoAppIdea.Web.Features.FeatureExpansion
@using PoAppIdea.Web.Features.Session
@inject FeatureExpansionService FeatureExpansionService
@inject SessionService SessionService
@inject NavigationManager Navigation
@inject Radzen.NotificationService NotificationService

<PageTitle>Feature Expansion - Define Capabilities</PageTitle>

<SessionBreadcrumb SessionId="SessionId" CurrentPhase="SessionPhase.Phase3_FeatureExpansion" />
<SessionProgress SessionId="SessionId" CurrentPhase="SessionPhase.Phase3_FeatureExpansion" />

<div class="feature-expansion-page animate-fade-in rz-p-4">
    <div class="dashboard-header glass-card rz-p-6 rz-mb-6">
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
            <RadzenStack Gap="0.25rem">
                <RadzenText TextStyle="TextStyle.DisplayH4" class="rz-m-0">
                    <RadzenIcon Icon="extension" Style="margin-right: 0.5rem; vertical-align: middle;" /> Feature Expansion
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" class="rz-text-secondary-color">
                    Explore different feature sets and service integrations for your ideas
                </RadzenText>
            </RadzenStack>

            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
                @if (!isLoading && variations.Count > 0 && hasMinimumRating)
                {
                    <RadzenButton Text="Continue" Icon="arrow_forward" ButtonStyle="ButtonStyle.Primary"
                                  Size="ButtonSize.Large" Click="@(( ) => Navigation.NavigateTo($"/session/{SessionId}/submit"))" class="glow-button" />
                }
                <RadzenButton Text="Back" Icon="arrow_back" ButtonStyle="ButtonStyle.Light" Variant="Variant.Text"
                              Click="@(() => Navigation.NavigateTo($"/session/{SessionId}/mutations"))" />
            </RadzenStack>
        </RadzenStack>
    </div>

    @if (isLoading)
    {
        <div class="skeleton-grid">
            <SkeletonLoader Variant="SkeletonLoader.SkeletonVariant.Card" Count="6" />
        </div>
    }
    else if (errorMessage != null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Title="Error" Text="@errorMessage" />
        <RadzenButton Text="Try Again" Click="@LoadVariations" />
    }
    else if (isGenerating)
    {
        <div class="glass-card rz-p-12 rz-text-align-center">
            <RadzenStack AlignItems="AlignItems.Center" Gap="1.5rem">
                <RadzenProgressBarCircular ShowValue="true" Mode="ProgressBarMode.Indeterminate"
                                           Size="ProgressBarCircularSize.Large" />
                <div>
                    <RadzenText TextStyle="TextStyle.H4">Generating Feature Variations...</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body1" class="rz-text-secondary-color">
                        Creating themes: Minimalist MVP &bull; Enterprise &bull; Privacy &bull; Social &bull; AI
                    </RadzenText>
                </div>
            </RadzenStack>
        </div>
    }
    else if (variations.Count == 0)
    {
        <div class="glass-card rz-p-12 rz-text-align-center">
            <RadzenStack AlignItems="AlignItems.Center" Gap="1.5rem">
                <RadzenIcon Icon="extension" Style="font-size: 80px; color: var(--app-primary-light); opacity: 0.5;" />
                <div>
                    <RadzenText TextStyle="TextStyle.H4">No Feature Variations Yet</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body1" class="rz-text-secondary-color">
                        Feature variations are being prepared from your top evolved ideas.
                    </RadzenText>
                </div>
                <RadzenButton Text="Generate Variations" Icon="auto_awesome" ButtonStyle="ButtonStyle.Primary"
                              Size="ButtonSize.Large" Click="@GenerateFeatures" class="glow-button" />
            </RadzenStack>
        </div>
    }
    else
    {
        @if (isRatingMode)
        {
            <div class="glass-card rz-p-4 rz-mb-6 highlight-border">
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                        <RadzenBadge BadgeStyle="BadgeStyle.Warning" Text="Rating Mode" Variant="Variant.Flat" />
                        <RadzenText TextStyle="TextStyle.Body1">Rate at least one variation to continue.</RadzenText>
                    </RadzenStack>
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                         <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-m-0">
                            Rated: @ratedCount / @variations.Count
                        </RadzenText>
                        <RadzenButton Text="Exit Rating" Icon="close" ButtonStyle="ButtonStyle.Light" Variant="Variant.Text"
                                      Click="@(() => isRatingMode = false)" />
                    </RadzenStack>
                </RadzenStack>
                <RadzenProgressBar Value="@((double)ratedCount / variations.Count * 100)" ShowValue="false" class="rz-mt-2" 
                                   ProgressBarStyle="ProgressBarStyle.Warning" />
            </div>
        }

        <div class="filters-container rz-mb-4">
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Wrap="FlexWrap.Wrap">
                <RadzenButton Text="All" ButtonStyle="@(filterTheme == null ? ButtonStyle.Primary : ButtonStyle.Light)"
                              Size="ButtonSize.Small" Click="@(() => filterTheme = null)" class="@(filterTheme == null ? "glow-button" : "")" />
                @foreach (var theme in ThemeFilters)
                {
                    <RadzenButton Text="@theme" ButtonStyle="@(filterTheme == theme ? ButtonStyle.Info : ButtonStyle.Light)"
                                  Size="ButtonSize.Small" Click="@(() => filterTheme = theme)" />
                }
            </RadzenStack>
        </div>

        <RadzenRow Gap="1.5rem">
            @foreach (var variation in FilteredVariations)
            {
                <RadzenColumn Size="12" SizeMD="6" SizeLG="4">
                    <FeatureCard Variation="@variation" IsRating="@isRatingMode" OnRated="@HandleRating" />
                </RadzenColumn>
            }
        </RadzenRow>

        @if (!isRatingMode && variations.Count > 0 && !showTopVariations)
        {
            <div class="glass-card rz-p-8 rz-mt-8 rz-text-align-center">
                <RadzenStack AlignItems="AlignItems.Center" Gap="1.5rem">
                    <RadzenText TextStyle="TextStyle.H5">Ready to Finalize?</RadzenText>
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
                        <RadzenButton Text="Rate Variations" Icon="star" ButtonStyle="ButtonStyle.Warning"
                                      Click="@(() => isRatingMode = true)" class="glow-button" />
                        <RadzenButton Text="Submit Session" Icon="send" ButtonStyle="ButtonStyle.Primary"
                                      Disabled="@(!hasMinimumRating)" class="@(hasMinimumRating ? "glow-button" : "")"
                                      Click="@(( ) => Navigation.NavigateTo($"/session/{SessionId}/submit"))" />
                    </RadzenStack>
                </RadzenStack>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public Guid SessionId { get; set; }

    private List<FeatureVariationDto> variations = [];
    private List<FeatureVariationDto> topVariations = [];

    private bool isLoading = true;
    private bool isGenerating = false;
    private bool isRatingMode = false;
    private bool showTopVariations = false;
    private string? errorMessage;
    private string? filterTheme;

    private static readonly string[] ThemeFilters =
    [
        "Minimalist MVP",
        "Enterprise-Ready",
        "Privacy-First",
        "Social-Heavy",
        "AI-Powered"
    ];

    private int ratedCount => variations.Count(v => v.Score > 0);
    private bool hasMinimumRating => ratedCount > 0;

    private IEnumerable<FeatureVariationDto> FilteredVariations =>
        showTopVariations ? topVariations :
        filterTheme != null ? variations.Where(v => v.VariationTheme == filterTheme) :
        variations;

    protected override async Task OnInitializedAsync()
    {
        await LoadVariations();

        if (variations.Count == 0 && errorMessage == null)
        {
            // Auto-generate feature variations from top mutations
            await GenerateFeatures();
            isRatingMode = variations.Count > 0;
            StateHasChanged();
        }
    }

    private async Task LoadVariations()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var result = await FeatureExpansionService.GetFeatureVariationsAsync(SessionId);
            variations = result.ToList();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task GenerateFeatures()
    {
        isGenerating = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            var request = new ExpandFeaturesRequest();
            var response = await FeatureExpansionService.GenerateFeatureVariationsAsync(SessionId, request);
            variations = response.Variations.ToList();

            NotificationService.Notify(new Radzen.NotificationMessage
            {
                Severity = Radzen.NotificationSeverity.Success,
                Summary = "Feature Variations Generated!",
                Detail = $"Created {response.TotalVariations} variations from {response.MutationsProcessed} mutations",
                Duration = 5000
            });
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            NotificationService.Notify(new Radzen.NotificationMessage
            {
                Severity = Radzen.NotificationSeverity.Error,
                Summary = "Generation Failed",
                Detail = ex.Message,
                Duration = 5000
            });
        }
        finally
        {
            isGenerating = false;
        }
    }

    private async Task HandleRating((Guid variationId, float score) rating)
    {
        try
        {
            var request = new RateFeatureVariationRequest { Score = rating.score };
            var updated = await FeatureExpansionService.RateVariationAsync(SessionId, rating.variationId, request);

            // Update local state
            var index = variations.FindIndex(v => v.Id == rating.variationId);
            if (index >= 0)
            {
                variations[index] = updated;
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new Radzen.NotificationMessage
            {
                Severity = Radzen.NotificationSeverity.Error,
                Summary = "Rating Failed",
                Detail = ex.Message,
                Duration = 3000
            });
        }
    }

    private async Task ShowTopVariations()
    {
        try
        {
            topVariations = (await FeatureExpansionService.GetTopVariationsAsync(SessionId)).ToList();
            showTopVariations = true;
            isRatingMode = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new Radzen.NotificationMessage
            {
                Severity = Radzen.NotificationSeverity.Error,
                Summary = "Failed to load top variations",
                Detail = ex.Message,
                Duration = 3000
            });
        }
    }
}

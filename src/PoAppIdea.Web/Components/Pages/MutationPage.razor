@page "/session/{SessionId:guid}/mutations"
@page "/session/{SessionId:guid}/evolve"
@using PoAppIdea.Core.Enums
@using PoAppIdea.Shared.Contracts
@using PoAppIdea.Web.Features.Mutation
@using PoAppIdea.Web.Features.Session
@using PoAppIdea.Web.Components.Shared
@inject MutationService MutationService
@inject SessionService SessionService
@inject NavigationManager Navigation
@inject Radzen.NotificationService NotificationService

<PageTitle>Mutations - Evolve Ideas</PageTitle>

<SessionBreadcrumb SessionId="SessionId" CurrentPhase="SessionPhase.Phase2_Mutation" />
<SessionProgress SessionId="SessionId" CurrentPhase="SessionPhase.Phase2_Mutation" />

<div class="mutation-page animate-fade-in rz-p-4">
    <div class="dashboard-header glass-card rz-p-6 rz-mb-6">
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
            <RadzenStack Gap="0.25rem">
                <RadzenText TextStyle="TextStyle.DisplayH4" class="rz-m-0">
                    <RadzenIcon Icon="auto_fix_high" Style="margin-right: 0.5rem; vertical-align: middle;" /> Mutations
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" class="rz-text-secondary-color">
                    Rate evolved ideas from crossover and repurposing
                </RadzenText>
            </RadzenStack>

            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
                @if (!isLoading && mutations.Count == 0)
                {
                    <RadzenButton Text="Generate Mutations" Icon="bolt" ButtonStyle="ButtonStyle.Primary"
                                  IsBusy="@isGenerating" Click="@GenerateMutations" class="glow-button" />
                }
                else if (!isLoading && mutations.Count > 0 && hasMinimumRating)
                {
                    <RadzenButton Text="Continue" Icon="arrow_forward" ButtonStyle="ButtonStyle.Primary"
                                  Size="ButtonSize.Large" Click="@(() => Navigation.NavigateTo($"/session/{SessionId}/features"))" class="glow-button" />
                }
            </RadzenStack>
        </RadzenStack>
    </div>

    @if (isLoading)
    {
        <div class="skeleton-grid rz-p-4">
            <SkeletonLoader Variant="SkeletonLoader.SkeletonVariant.Card" Count="6" />
        </div>
    }
    else if (errorMessage != null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Title="Error" Text="@errorMessage" />
        <RadzenButton Text="Try Again" Click="@LoadMutations" />
    }
    else if (mutations.Count == 0)
    {
        <div class="glass-card rz-p-12 rz-text-align-center">
            <RadzenStack AlignItems="AlignItems.Center" Gap="1.5rem">
                <RadzenIcon Icon="science" Style="font-size: 80px; color: var(--app-secondary-light); opacity: 0.5;" />
                <div>
                    <RadzenText TextStyle="TextStyle.H4">No Evolutions Yet</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body1" class="rz-text-secondary-color">
                        Generate evolved variations from your top 3 ideas.
                    </RadzenText>
                </div>
                <RadzenButton Text="Generate Evolutions" Icon="bolt" Size="ButtonSize.Large"
                              ButtonStyle="ButtonStyle.Primary" IsBusy="@isGenerating" Click="@GenerateMutations" class="glow-button" />
            </RadzenStack>
        </div>
    }
    else
    {
        @if (isRatingMode)
        {
            <div class="glass-card rz-p-4 rz-mb-6 highlight-border">
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                        <RadzenBadge BadgeStyle="BadgeStyle.Warning" Text="Rating Mode" Variant="Variant.Flat" />
                        <RadzenText TextStyle="TextStyle.Body1">Rate at least one mutation to continue.</RadzenText>
                    </RadzenStack>
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                         <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-m-0">
                            Rated: @ratedCount / @mutations.Count
                        </RadzenText>
                        <RadzenButton Text="Exit Rating" Icon="close" ButtonStyle="ButtonStyle.Light" Variant="Variant.Text"
                                      Click="@(() => isRatingMode = false)" />
                    </RadzenStack>
                </RadzenStack>
                <RadzenProgressBar Value="@((double)ratedCount / mutations.Count * 100)" ShowValue="false" class="rz-mt-2" 
                                   ProgressBarStyle="ProgressBarStyle.Warning" />
            </div>
        }

        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" class="rz-mb-4">
            <RadzenButton Text="All" ButtonStyle="@(filterType == null ? ButtonStyle.Primary : ButtonStyle.Light)"
                          Size="ButtonSize.Small" Click="@(() => filterType = null)" />
            <RadzenButton Text="Crossover" ButtonStyle="@(filterType == MutationType.Crossover ? ButtonStyle.Info : ButtonStyle.Light)"
                          Size="ButtonSize.Small" Click="@(() => filterType = MutationType.Crossover)" />
            <RadzenButton Text="Repurposing" ButtonStyle="@(filterType == MutationType.Repurposing ? ButtonStyle.Success : ButtonStyle.Light)"
                          Size="ButtonSize.Small" Click="@(() => filterType = MutationType.Repurposing)" />
        </RadzenStack>

        <RadzenRow Gap="1.5rem">
            @foreach (var mutation in FilteredMutations)
            {
                <RadzenColumn Size="12" SizeMD="6" SizeLG="4">
                    <MutationCard Mutation="@mutation" IsRating="@isRatingMode" OnRated="@HandleRating" />
                </RadzenColumn>
            }
        </RadzenRow>
    }
</div>

@code {
    [Parameter]
    public Guid SessionId { get; set; }

    private List<MutationDto> mutations = [];

    private bool isLoading = true;
    private bool isGenerating = false;
    private bool isRatingMode = false;
    private string? errorMessage;
    private MutationType? filterType;

    private int ratedCount => mutations.Count(m => m.Score > 0);
    private bool hasMinimumRating => ratedCount > 0;

    private IEnumerable<MutationDto> FilteredMutations =>
        filterType.HasValue ? mutations.Where(m => m.MutationType == filterType.Value) :
        mutations;

    protected override async Task OnInitializedAsync()
    {
        await LoadMutations();
        
        // Auto-generate mutations if none exist
        if (mutations.Count == 0 && errorMessage == null)
        {
            await GenerateMutations();
        }
        
        // Auto-start rating mode if mutations exist
        if (mutations.Count > 0)
        {
            isRatingMode = true;
            StateHasChanged();
        }
    }

    private async Task LoadMutations()
    {
        isLoading = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            var result = await MutationService.GetMutationsAsync(SessionId);
            mutations = result.ToList();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task GenerateMutations()
    {
        isGenerating = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            var request = new MutateIdeasRequest();
            var response = await MutationService.GenerateMutationsAsync(SessionId, request);
            mutations = response.Mutations.ToList();
            
            // Auto-start rating mode after generation
            isRatingMode = true;

            NotificationService.Notify(new Radzen.NotificationMessage
            {
                Severity = Radzen.NotificationSeverity.Success,
                Summary = "Mutations Generated!",
                Detail = $"Created {response.TotalMutations} mutations ({response.CrossoverCount} crossover, {response.RepurposingCount} repurposing)",
                Duration = 5000
            });
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            NotificationService.Notify(new Radzen.NotificationMessage
            {
                Severity = Radzen.NotificationSeverity.Error,
                Summary = "Error",
                Detail = ex.Message,
                Duration = 5000
            });
        }
        finally
        {
            isGenerating = false;
        }
    }

    private async Task HandleRating((Guid MutationId, float Score) rating)
    {
        try
        {
            var request = new RateMutationRequest { Score = rating.Score };
            var updated = await MutationService.RateMutationAsync(SessionId, rating.MutationId, request);

            var index = mutations.FindIndex(m => m.Id == rating.MutationId);
            if (index >= 0)
            {
                mutations[index] = updated;
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new Radzen.NotificationMessage
            {
                Severity = Radzen.NotificationSeverity.Error,
                Summary = "Rating Failed",
                Detail = ex.Message,
                Duration = 3000
            });
        }
    }

}

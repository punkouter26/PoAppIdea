@page "/session/{SessionId:guid}/refinement"
@page "/session/{SessionId:guid}/refine"
@using PoAppIdea.Core.Enums
@using PoAppIdea.Web.Features.Refinement
@using PoAppIdea.Web.Components.Shared
@using PoAppIdea.Web.Infrastructure
@inject RefinementService RefinementService
@inject NavigationManager Navigation
@inject Radzen.NotificationService NotificationService
@inject UIService UIService
@inject ILogger<RefinementPage> Logger
@implements IDisposable

<PageTitle>Refinement - PoAppIdea</PageTitle>

<SessionBreadcrumb SessionId="SessionId" CurrentPhase="SessionPhase.Phase4_ProductRefinement" />
<SessionProgress SessionId="SessionId" CurrentPhase="SessionPhase.Phase4_ProductRefinement" />

<div class="refinement-page animate-fade-in rz-p-4 @(UIService.IsFocusMode ? "focus-mode-active" : "")">
    @if (!UIService.IsFocusMode)
    {
        <div class="dashboard-header glass-card rz-p-6 rz-mb-6">
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                <RadzenStack Gap="0.25rem">
                    <RadzenText TextStyle="TextStyle.DisplayH4" class="rz-m-0">
                        <RadzenIcon Icon="psychology" Style="margin-right: 0.5rem; vertical-align: middle;" /> Deep Refinement
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body1" class="rz-text-secondary-color">
                        Defining the @(_questionsResponse?.Phase == RefinementPhase.Phase4_PM ? "Product Strategy" : "Technical Architecture")
                    </RadzenText>
                </RadzenStack>

                <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
                    <RadzenButton Click="@(() => UIService.ToggleFocusMode())" 
                                Icon="visibility_off" 
                                ButtonStyle="ButtonStyle.Light" 
                                Variant="Variant.Text"
                                Text="Focus Mode" />
                </RadzenStack>
            </RadzenStack>
        </div>
    }
    else
    {
        <div class="focus-mode-exit">
            <RadzenButton Click="@(() => UIService.ToggleFocusMode())" 
                        Icon="visibility" 
                        ButtonStyle="ButtonStyle.Light" 
                        Variant="Variant.Text"
                        Text="Exit Focus" />
        </div>
    }

    @if (_loading)
    {
        <div class="skeleton-grid rz-mt-4">
            <SkeletonLoader Variant="SkeletonLoader.SkeletonVariant.List" Count="5" />
        </div>
    }
    else if (_error is not null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Title="Error" Text="@_error" />
    }
    else if (_questionsResponse is not null)
    {
        <div class="glass-card rz-p-4 rz-mb-6 highlight-border">
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-m-0">
                    Phase Progress: @_questionsResponse.AnsweredCount / 5 Questions
                </RadzenText>
                <div style="flex-grow: 1; max-width: 300px; margin: 0 2rem;">
                    <RadzenProgressBar Value="@(_progressPercent)" ShowValue="false" 
                                       ProgressBarStyle="@(_progressPercent == 100 ? ProgressBarStyle.Success : ProgressBarStyle.Primary)" />
                </div>
                <RadzenBadge BadgeStyle="@(_progressPercent == 100 ? BadgeStyle.Success : BadgeStyle.Info)" 
                             Text="@(_progressPercent == 100 ? "Complete" : "In Progress")" Variant="Variant.Flat" />
            </RadzenStack>
        </div>

        <div class="questions-container">
            @foreach (var categoryGroup in _questionsResponse.Questions.GroupBy(q => q.Category))
            {
                <div class="category-group rz-mb-8">
                    <RadzenText TextStyle="TextStyle.H5" class="rz-mb-4" Style="font-weight: 700; color: var(--app-primary-light);">
                        @FormatCategory(categoryGroup.Key)
                    </RadzenText>
                    <RadzenStack Gap="1.5rem">
                        @foreach (var question in categoryGroup)
                        {
                            <QuestionCard 
                                Question="@question"
                                OnAnswerChanged="@((answer) => HandleAnswerChanged(question.QuestionNumber, answer))"
                                Answer="@GetAnswer(question.QuestionNumber)" />
                        }
                    </RadzenStack>
                </div>
            }
        </div>

        <div class="glass-card rz-p-8 rz-mt-8 rz-text-align-center">
            <RadzenStack AlignItems="AlignItems.Center" Gap="1.5rem">
                @if (_answeredCount < 5)
                {
                    <RadzenText TextStyle="TextStyle.H6">Answer at least one question to save progress</RadzenText>
                    <RadzenButton Text="@($"Submit Phase Answers ({_answeredCount}/5)")" 
                        Icon="send" 
                        ButtonStyle="ButtonStyle.Primary"
                        Size="ButtonSize.Large"
                        Disabled="@(_submitting || _answeredCount == 0)"
                        Click="@SubmitAnswers" class="@(_answeredCount > 0 ? "glow-button" : "")" />
                }
                else
                {
                    <RadzenText TextStyle="TextStyle.H5">Phase Complete! Ready to Save?</RadzenText>
                    <RadzenButton Text="Submit All Answers" 
                        Icon="check_circle" 
                        ButtonStyle="ButtonStyle.Success"
                        Size="ButtonSize.Large"
                        Disabled="@_submitting"
                        Click="@SubmitAnswers" class="glow-button" />
                }
            </RadzenStack>
        </div>
    }
</div>

@code {
    [Parameter]
    public Guid SessionId { get; set; }

    private GetQuestionsResponse? _questionsResponse;
    private Dictionary<int, string> _answers = new();
    private bool _loading = true;
    private bool _submitting;
    private string? _error;

    private int _answeredCount => _answers.Count(a => !string.IsNullOrWhiteSpace(a.Value));
    private double _progressPercent => _questionsResponse is null ? 0 : (_answeredCount / 5.0) * 100;

    protected override async Task OnInitializedAsync()
    {
        UIService.OnFocusModeChanged += HandleFocusModeChanged;
        await LoadQuestionsAsync();
    }

    private void HandleFocusModeChanged(bool isFocus) => StateHasChanged();

    private async Task LoadQuestionsAsync()
    {
        try
        {
            _loading = true;
            _error = null;

            _questionsResponse = await RefinementService.GetQuestionsAsync(SessionId);

            // Pre-populate answers: use existing responses if available, otherwise pre-fill with example answers
            foreach (var question in _questionsResponse.Questions)
            {
                if (question.IsAnswered && question.ExistingAnswer is not null)
                {
                    _answers[question.QuestionNumber] = question.ExistingAnswer!;
                }
                else if (!_answers.ContainsKey(question.QuestionNumber))
                {
                    // Default to "I DON'T CARE" so users can quickly skip or edit
                    _answers[question.QuestionNumber] = "I DON'T CARE";
                }
            }

            Logger.LogInformation(
                "Loaded {Count} questions for session {SessionId}, {Answered} already answered",
                _questionsResponse.Questions.Count, SessionId, _questionsResponse.AnsweredCount);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load questions for session {SessionId}", SessionId);
            _error = $"Failed to load questions: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }

    private void HandleAnswerChanged(int questionNumber, string answer)
    {
        _answers[questionNumber] = answer;
        Logger.LogDebug("Answer updated for Q{QuestionNumber}: {Length} chars", questionNumber, answer?.Length ?? 0);
    }

    private string GetAnswer(int questionNumber)
    {
        return _answers.TryGetValue(questionNumber, out var answer) ? answer : string.Empty;
    }

    private async Task SubmitAnswers()
    {
        // Allow submitting with 0 answers (user chose to skip all questions)

        try
        {
            _submitting = true;

            var answeredItems = _answers
                .Where(a => !string.IsNullOrWhiteSpace(a.Value))
                .Select(a => new AnswerInput
                {
                    QuestionNumber = a.Key,
                    AnswerText = a.Value
                })
                .ToList();

            var request = new SubmitAnswersRequest
            {
                Answers = answeredItems,
                SkipRemaining = true // Allow advancing even with blank answers
            };

            var response = await RefinementService.SubmitAnswersAsync(SessionId, request);

            Logger.LogInformation(
                "Submitted {Count} answers for session {SessionId}. Refinement complete: {Complete}",
                response.AnswersRecorded, SessionId, response.RefinementComplete);

            NotificationService.Notify(new Radzen.NotificationMessage
            {
                Severity = Radzen.NotificationSeverity.Success,
                Summary = "Answers Submitted",
                Detail = response.Message
            });

            // Navigate based on completion status
            if (response.RefinementComplete)
            {
                // All refinement done, go to visual phase
                Navigation.NavigateTo($"/session/{SessionId}/visual");
            }
            else if (response.NextPhase == SessionPhase.Phase5_TechnicalRefinement)
            {
                // PM questions done, reload for architect questions
                _answers.Clear();
                await LoadQuestionsAsync();
            }
            else
            {
                // Partial submit, refresh
                await LoadQuestionsAsync();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to submit answers for session {SessionId}", SessionId);
            NotificationService.Notify(new Radzen.NotificationMessage
            {
                Severity = Radzen.NotificationSeverity.Error,
                Summary = "Submission Failed",
                Detail = ex.Message
            });
        }
        finally
        {
            _submitting = false;
        }
    }

    private static string FormatCategory(string category)
    {
        // Convert PascalCase to Title Case with spaces
        return System.Text.RegularExpressions.Regex.Replace(category, "(\\B[A-Z])", " $1");
    }

    public void Dispose()
    {
        UIService.OnFocusModeChanged -= HandleFocusModeChanged;
    }
}

@page "/session/{SessionId:guid}/submit"
@page "/session/{SessionId:guid}/synthesize"
@using PoAppIdea.Core.Enums
@using PoAppIdea.Shared.Contracts
@using PoAppIdea.Web.Components.Shared
@using PoAppIdea.Web.Features.Synthesis
@using PoAppIdea.Web.Features.Session
@inject SynthesisService SynthesisService
@inject SessionService SessionService
@inject NavigationManager Navigation
@inject Radzen.NotificationService NotificationService

<PageTitle>Submit Ideas - Select & Synthesize</PageTitle>

<SessionBreadcrumb SessionId="SessionId" CurrentPhase="SessionPhase.Submission" />
<SessionProgress SessionId="SessionId" CurrentPhase="SessionPhase.Submission" />

<div class="submission-page animate-fade-in rz-p-4">
    <div class="dashboard-header glass-card rz-p-6 rz-mb-6">
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
            <RadzenStack Gap="0.25rem">
                <RadzenText TextStyle="TextStyle.DisplayH4" class="rz-m-0">
                    <RadzenIcon Icon="check_circle" Style="margin-right: 0.5rem; vertical-align: middle;" /> Final Selection
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" class="rz-text-secondary-color">
                    Select your final app candidate to begin deep-dive refinement
                </RadzenText>
            </RadzenStack>

            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
                <RadzenButton Text="Back" Icon="arrow_back" ButtonStyle="ButtonStyle.Light" Variant="Variant.Text"
                              data-testid="back-to-features"
                              Click="@(() => Navigation.NavigateTo($"/session/{SessionId}/features"))" />
            </RadzenStack>
        </RadzenStack>
    </div>

    @if (isLoading)
    {
        <div class="skeleton-grid">
            <SkeletonLoader Variant="SkeletonLoader.SkeletonVariant.Card" Count="6" />
        </div>
    }
    else if (errorMessage != null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Title="Error" Text="@errorMessage" />
        <RadzenButton Text="Try Again" Click="@LoadSelectableIdeas" />
    }
    else if (synthesis is not null)
    {
        <div class="glass-card rz-p-6 rz-mb-6 highlight-border">
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                    <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Synthesis Ready" Variant="Variant.Flat" />
                    <RadzenText TextStyle="TextStyle.Body1">Your final app concept has been generated.</RadzenText>
                </RadzenStack>
                <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
                    <RadzenButton Text="Change Choice" Icon="edit" ButtonStyle="ButtonStyle.Light" Variant="Variant.Text"
                                  Click="@ResetToSelection" />
                    <RadzenButton Text="Deep Dive Refinement" Icon="psychology" ButtonStyle="ButtonStyle.Primary"
                                  Click="@(() => Navigation.NavigateTo($"/session/{SessionId}/refinement"))" class="glow-button" />
                </RadzenStack>
            </RadzenStack>
        </div>
        
        <SynthesisPreview Synthesis="@synthesis" />
    }
    else
    {
        <div class="glass-card rz-p-4 rz-mb-6">
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                <RadzenText TextStyle="TextStyle.H6" class="rz-m-0">
                    Select 1 Candidate
                </RadzenText>
                <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
                    <RadzenButton Text="Clear" Icon="clear" ButtonStyle="ButtonStyle.Light" Variant="Variant.Text"
                                  Disabled="@(selectedCount == 0)" Click="@ClearSelection" />
                    <RadzenButton Text="Synthesize Selection" Icon="auto_fix_high" ButtonStyle="ButtonStyle.Primary"
                                  Disabled="@(selectedCount == 0)" IsBusy="@isSubmitting" Click="@SubmitSelection" class="@(selectedCount > 0 ? "glow-button" : "")" />
                </RadzenStack>
            </RadzenStack>
        </div>

        @if (selectableIdeas.Count == 0)
        {
             <div class="glass-card rz-p-12 rz-text-align-center">
                <RadzenStack AlignItems="AlignItems.Center" Gap="1.5rem">
                    <RadzenIcon Icon="layers_clear" Style="font-size: 80px; color: var(--app-primary-light); opacity: 0.5;" />
                    <div>
                        <RadzenText TextStyle="TextStyle.H4">No Candidates Found</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body1" class="rz-text-secondary-color">
                            Go back to Phase 3 to generate feature sets for your evolved ideas.
                        </RadzenText>
                    </div>
                    <RadzenButton Text="Back to Expansion" Icon="extension" ButtonStyle="ButtonStyle.Primary"
                                  Click="@(() => Navigation.NavigateTo($"/session/{SessionId}/features"))" class="glow-button" />
                </RadzenStack>
            </div>
        }
        else
        {
            <RadzenRow Gap="1.5rem">
                @foreach (var idea in selectableIdeas)
                {
                    <RadzenColumn Size="12" SizeMD="6" SizeLG="4">
                        <div @onclick="() => ToggleSelection(idea)"
                             class="glass-card selection-card rz-p-5 @(IsSelected(idea) ? "selected-card" : "")" 
                             style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;">
                            <RadzenStack Gap="0.75rem">
                                @* Header: Theme tag + check icon *@
                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Start">
                                    <RadzenStack Gap="0.25rem" Style="flex: 1; min-width: 0;">
                                        <RadzenText TextStyle="TextStyle.H5" class="rz-m-0" Style="font-weight: 700;">
                                            @idea.Title
                                        </RadzenText>
                                    </RadzenStack>
                                    @if (IsSelected(idea))
                                    {
                                        <RadzenIcon Icon="check_circle" Style="color: var(--app-primary-light); font-size: 24px; flex-shrink: 0;" />
                                    }
                                </RadzenStack>

                                @* Tags row: variation theme + mutation type *@
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Wrap="FlexWrap.Wrap">
                                    @if (!string.IsNullOrEmpty(idea.MutationType))
                                    {
                                        <RadzenBadge BadgeStyle="@GetMutationBadgeStyle(idea.MutationType)" 
                                                     Text="@idea.MutationType" Variant="Variant.Outlined" 
                                                     Style="font-size: 0.7rem;" />
                                    }
                                    <RadzenBadge BadgeStyle="BadgeStyle.Light" 
                                                 Text="@($"{idea.FeatureCount} features")" 
                                                 Variant="Variant.Outlined" 
                                                 Style="font-size: 0.7rem;" />
                                </RadzenStack>
                                
                                @* Description *@
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-text-secondary-color" 
                                            Style="min-height: 3rem; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;">
                                    @idea.Description
                                </RadzenText>

                                @* MoSCoW breakdown bar *@
                                <div class="moscow-bar" style="display: flex; height: 6px; border-radius: 3px; overflow: hidden; gap: 2px;">
                                    @if (idea.MustCount > 0)
                                    {
                                        <div style="flex: @idea.MustCount; background: #e74c3c; border-radius: 3px;" title="@($"Must: {idea.MustCount}")"></div>
                                    }
                                    @if (idea.ShouldCount > 0)
                                    {
                                        <div style="flex: @idea.ShouldCount; background: #f39c12; border-radius: 3px;" title="@($"Should: {idea.ShouldCount}")"></div>
                                    }
                                    @if (idea.CouldCount > 0)
                                    {
                                        <div style="flex: @idea.CouldCount; background: #3498db; border-radius: 3px;" title="@($"Could: {idea.CouldCount}")"></div>
                                    }
                                </div>
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.75rem" Style="font-size: 0.7rem;">
                                    <span style="color: #e74c3c;">● Must: @idea.MustCount</span>
                                    <span style="color: #f39c12;">● Should: @idea.ShouldCount</span>
                                    <span style="color: #3498db;">● Could: @idea.CouldCount</span>
                                </RadzenStack>

                                @* Feature list *@
                                @if (idea.TopFeatures.Count > 0)
                                {
                                    <div style="border-top: 1px solid rgba(255,255,255,0.08); padding-top: 0.5rem;">
                                        <RadzenText TextStyle="TextStyle.Caption" Style="font-weight: 600; margin-bottom: 0.25rem; opacity: 0.7;">
                                            KEY FEATURES
                                        </RadzenText>
                                        <RadzenStack Gap="0.25rem">
                                            @foreach (var feature in idea.TopFeatures)
                                            {
                                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.4rem" AlignItems="AlignItems.Start">
                                                    <RadzenIcon Icon="@GetPriorityIcon(feature.Priority)" 
                                                                Style="@($"font-size: 14px; color: {GetPriorityColor(feature.Priority)}; margin-top: 2px; flex-shrink: 0;")" />
                                                    <RadzenStack Gap="0">
                                                        <RadzenText TextStyle="TextStyle.Caption" Style="font-weight: 600; line-height: 1.3;">
                                                            @feature.Name
                                                        </RadzenText>
                                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-text-secondary-color" 
                                                                    Style="font-size: 0.7rem; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                                            @feature.Description
                                                        </RadzenText>
                                                    </RadzenStack>
                                                </RadzenStack>
                                            }
                                        </RadzenStack>
                                    </div>
                                }

                                @* Integrations *@
                                @if (idea.Integrations.Count > 0)
                                {
                                    <div style="border-top: 1px solid rgba(255,255,255,0.08); padding-top: 0.5rem;">
                                        <RadzenText TextStyle="TextStyle.Caption" Style="font-weight: 600; margin-bottom: 0.25rem; opacity: 0.7;">
                                            INTEGRATIONS
                                        </RadzenText>
                                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.35rem" Wrap="FlexWrap.Wrap">
                                            @foreach (var integration in idea.Integrations)
                                            {
                                                <RadzenBadge Text="@integration" BadgeStyle="BadgeStyle.Info" 
                                                             Variant="Variant.Outlined" 
                                                             Style="font-size: 0.65rem; padding: 0.15rem 0.4rem;" />
                                            }
                                        </RadzenStack>
                                    </div>
                                }

                                @* Mutation rationale *@
                                @if (!string.IsNullOrEmpty(idea.MutationRationale))
                                {
                                    <div style="border-top: 1px solid rgba(255,255,255,0.08); padding-top: 0.5rem;">
                                        <RadzenText TextStyle="TextStyle.Caption" Style="font-weight: 600; margin-bottom: 0.15rem; opacity: 0.7;">
                                            <RadzenIcon Icon="auto_fix_high" Style="font-size: 12px; vertical-align: middle;" /> WHY THIS VARIATION
                                        </RadzenText>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-text-secondary-color" 
                                                    Style="font-style: italic; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                            @idea.MutationRationale
                                        </RadzenText>
                                    </div>
                                }

                                @* Footer: score *@
                                <div class="card-footer rz-pt-3" style="border-top: 1px solid rgba(255,255,255,0.1);">
                                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" AlignItems="AlignItems.Center">
                                        <RadzenBadge BadgeStyle="BadgeStyle.Primary" Text="@($"Score: {idea.Score:F1}")" Variant="Variant.Flat" />
                                    </RadzenStack>
                                </div>
                            </RadzenStack>
                        </div>
                    </RadzenColumn>
                }
            </RadzenRow>
        }
    }
</div>

<style>
    .selection-card {
        border: 2px solid transparent;
    }
    .selection-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0,0,0,0.3);
        border-color: rgba(255,255,255,0.1);
    }
    .selected-card {
        border-color: var(--app-primary-light) !important;
        background: rgba(var(--app-primary-rgb), 0.1) !important;
    }
</style>

@code {
    [Parameter]
    public Guid SessionId { get; set; }

    private List<SelectableIdeaDto> selectableIdeas = new();
    private HashSet<Guid> selectedIds = new();
    private SynthesisDto? synthesis;
    
    private bool isLoading = true;
    private bool isSubmitting = false;
    private string? errorMessage;
    
    private int selectedCount => selectedIds.Count;

    protected override async Task OnInitializedAsync()
    {
        await LoadSelectableIdeas();
    }

    private async Task LoadSelectableIdeas()
    {
        isLoading = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            // Check if synthesis already exists
            synthesis = await SynthesisService.GetSynthesisAsync(SessionId);
            
            if (synthesis is null)
            {
                selectableIdeas = await SynthesisService.GetSelectableIdeasAsync(SessionId);
                
                // Pre-select any already selected ideas
                foreach (var idea in selectableIdeas.Where(i => i.IsSelected))
                {
                    selectedIds.Add(idea.Id);
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ToggleSelection(SelectableIdeaDto idea)
    {
        if (selectedIds.Contains(idea.Id))
        {
            selectedIds.Remove(idea.Id);
        }
        else
        {
            selectedIds.Clear();
            selectedIds.Add(idea.Id);
        }
        StateHasChanged();
    }

    private void ClearSelection()
    {
        selectedIds.Clear();
        StateHasChanged();
    }

    private bool IsSelected(SelectableIdeaDto idea) => selectedIds.Contains(idea.Id);

    private string GetCardStyle(SelectableIdeaDto idea)
    {
        if (IsSelected(idea))
        {
            return "border: 2px solid var(--rz-primary); background: var(--rz-primary-lighter);";
        }
        return "border: 2px solid transparent;";
    }

    private async Task SubmitSelection()
    {
        if (selectedIds.Count == 0)
        {
            NotificationService.Notify(new Radzen.NotificationMessage
            {
                Severity = Radzen.NotificationSeverity.Warning,
                Summary = "No Selection",
                Detail = "Please select at least one idea.",
                Duration = 3000
            });
            return;
        }

        isSubmitting = true;
        StateHasChanged();

        try
        {
            var request = new SubmitSelectionsRequest
            {
                SelectedIdeaIds = selectedIds.ToList()
            };

            var response = await SynthesisService.SubmitSelectionsAsync(SessionId, request);
            
            if (response.SynthesisPerformed && response.Synthesis is not null)
            {
                synthesis = response.Synthesis;
                NotificationService.Notify(new Radzen.NotificationMessage
                {
                    Severity = Radzen.NotificationSeverity.Success,
                    Summary = "Synthesis Complete",
                    Detail = $"Successfully merged {response.SubmittedCount} ideas into: {synthesis.MergedTitle}",
                    Duration = 5000
                });
            }
            else
            {
                NotificationService.Notify(new Radzen.NotificationMessage
                {
                    Severity = Radzen.NotificationSeverity.Success,
                    Summary = "Selection Submitted",
                    Detail = response.Message,
                    Duration = 3000
                });
                
                // Navigate to refinement for single selection
                Navigation.NavigateTo($"/session/{SessionId}/refinement");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new Radzen.NotificationMessage
            {
                Severity = Radzen.NotificationSeverity.Error,
                Summary = "Submission Failed",
                Detail = ex.Message,
                Duration = 5000
            });
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private void ResetToSelection()
    {
        synthesis = null;
        StateHasChanged();
    }

    private static BadgeStyle GetMutationBadgeStyle(string? mutationType) => mutationType switch
    {
        "Crossover" => BadgeStyle.Info,
        "Repurposing" => BadgeStyle.Success,
        _ => BadgeStyle.Secondary
    };

    private static string GetPriorityIcon(string priority) => priority switch
    {
        "Must" => "priority_high",
        "Should" => "arrow_upward",
        "Could" => "remove",
        _ => "help_outline"
    };

    private static string GetPriorityColor(string priority) => priority switch
    {
        "Must" => "#e74c3c",
        "Should" => "#f39c12",
        "Could" => "#3498db",
        _ => "#95a5a6"
    };
}

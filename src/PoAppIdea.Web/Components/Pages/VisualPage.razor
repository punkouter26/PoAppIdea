@page "/session/{SessionId:guid}/visual"
@page "/session/{SessionId:guid}/visualize"
@using PoAppIdea.Core.Enums
@using PoAppIdea.Web.Features.Visual
@using PoAppIdea.Web.Components.Shared
@using Radzen
@using Radzen.Blazor
@inject VisualService VisualService
@inject NavigationManager Navigation
@inject NotificationService NotificationService

<PageTitle>Visual Direction - PoAppIdea</PageTitle>

<SessionBreadcrumb SessionId="SessionId" CurrentPhase="SessionPhase.Phase6_Visual" />
<SessionProgress SessionId="SessionId" CurrentPhase="SessionPhase.Phase6_Visual" />

<div class="visual-page">
    <div class="page-header">
        <h1>ðŸŽ¨ Visual Direction</h1>
        <p class="subtitle">Choose the visual style that best represents your app's identity</p>
    </div>

    @if (_isLoading)
    {
        <div class="skeleton-gallery-grid">
            <SkeletonLoader Variant="SkeletonLoader.SkeletonVariant.Gallery" Count="3" />
        </div>
    }
    else if (_error is not null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" ShowIcon="true" Variant="Variant.Flat">
            @_error
        </RadzenAlert>
        <RadzenButton Text="Retry" Click="@LoadVisualsAsync" class="retry-button" />
    }
    else if (_response is null || _response.Visuals.Count == 0)
    {
        <div class="empty-state">
            <RadzenIcon Icon="image_not_supported" class="empty-icon" />
            <h3>No Visuals Generated Yet</h3>
            <p>Click the button below to generate 3 unique visual mockups for your app.</p>
            <RadzenButton Text="Generate Visuals" 
                          Icon="auto_awesome" 
                          ButtonStyle="ButtonStyle.Primary"
                          Size="ButtonSize.Large"
                          IsBusy="_isGenerating"
                          Click="@GenerateVisualsAsync" />
        </div>
    }
    else
    {
        <div class="generation-status">
            @if (_generationStatus is not null)
            {
                <RadzenProgressBar Value="@((_generationStatus.GeneratedCount / 10.0) * 100)" 
                                   ShowValue="true" 
                                   ProgressBarStyle="ProgressBarStyle.Primary"
                                   class="generation-progress" />
                <p class="status-text">
                    @(_generationStatus.Status switch
                    {
                        VisualGenerationStatus.Completed => "All visuals generated!",
                        VisualGenerationStatus.InProgress => $"Generating... {_generationStatus.GeneratedCount}/10 complete",
                        VisualGenerationStatus.Queued => "Generation queued...",
                        _ => "Unknown status"
                    })
                </p>
            }
        </div>

        <div class="visuals-grid">
            @foreach (var visual in _response.Visuals)
            {
                <VisualCard Asset="@visual" 
                            IsSelected="@visual.IsSelected"
                            OnSelect="@(() => SelectVisualAsync(visual.Id))" />
            }
        </div>

        @if (_response.HasSelection)
        {
            <div class="action-bar">
                <RadzenButton Text="Continue to Artifacts" 
                              Icon="arrow_forward" 
                              ButtonStyle="ButtonStyle.Primary"
                              Size="ButtonSize.Large"
                              Click="@ContinueToArtifacts" />
            </div>
        }
        else
        {
            <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="true" Variant="Variant.Flat" class="selection-hint">
                <strong>Select a visual direction</strong> by clicking on one of the mockups above.
            </RadzenAlert>
        }
    }
</div>

@code {
    [Parameter]
    public Guid SessionId { get; set; }

    private GetVisualsResponse? _response;
    private GenerateVisualsResponse? _generationStatus;
    private bool _isLoading = true;
    private bool _isGenerating;
    private string? _error;

    protected override async Task OnInitializedAsync()
    {
        await LoadVisualsAsync();
    }

    private async Task LoadVisualsAsync()
    {
        _isLoading = true;
        _error = null;
        StateHasChanged();

        try
        {
            _response = await VisualService.GetVisualsAsync(SessionId);
            _generationStatus = await VisualService.GetGenerationStatusAsync(SessionId);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task GenerateVisualsAsync()
    {
        _isGenerating = true;
        _error = null;
        StateHasChanged();

        try
        {
            var request = new GenerateVisualsRequest { Count = 10 };
            _generationStatus = await VisualService.GenerateVisualsAsync(SessionId, request);
            
            // Reload visuals after generation
            await LoadVisualsAsync();

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Visuals Generated",
                Detail = $"{_generationStatus.GeneratedCount} visual mockups created!",
                Duration = 4000
            });
        }
        catch (Exception ex)
        {
            _error = ex.Message;
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Generation Failed",
                Detail = ex.Message,
                Duration = 6000
            });
        }
        finally
        {
            _isGenerating = false;
            StateHasChanged();
        }
    }

    private async Task SelectVisualAsync(Guid assetId)
    {
        try
        {
            await VisualService.SelectVisualAsync(SessionId, assetId);
            
            // Update local state
            if (_response is not null)
            {
                var updatedVisuals = _response.Visuals.Select(v =>
                    new VisualAssetDto
                    {
                        Id = v.Id,
                        BlobUrl = v.BlobUrl,
                        ThumbnailUrl = v.ThumbnailUrl,
                        Prompt = v.Prompt,
                        StyleAttributes = v.StyleAttributes,
                        IsSelected = v.Id == assetId,
                        CreatedAt = v.CreatedAt
                    }).ToList();

                _response = new GetVisualsResponse
                {
                    SessionId = SessionId,
                    Visuals = updatedVisuals,
                    HasSelection = true,
                    SelectedVisualId = assetId
                };
            }

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Visual Selected",
                Detail = "You can now continue to artifact generation.",
                Duration = 3000
            });

            StateHasChanged();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Selection Failed",
                Detail = ex.Message,
                Duration = 6000
            });
        }
    }

    private void ContinueToArtifacts()
    {
        Navigation.NavigateTo($"/session/{SessionId}/artifacts");
    }
}

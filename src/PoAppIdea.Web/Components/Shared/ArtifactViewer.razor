@using PoAppIdea.Core.Enums
@using PoAppIdea.Web.Features.Artifacts
@using Markdig
@using Radzen
@using Radzen.Blazor

<div class="artifact-viewer">
    @if (Artifact is null)
    {
        <div class="empty-viewer">
            <p>No artifact selected</p>
        </div>
    }
    else
    {
        <div class="viewer-toolbar">
            <div class="toolbar-left">
                <RadzenBadge BadgeStyle="@GetBadgeStyle()" Text="@Artifact.Type.ToString()" />
                <span class="word-count">@GetWordCount() words</span>
            </div>
            <div class="toolbar-right">
                @if (ShowCopyButton)
                {
                    <RadzenButton Icon="content_copy" 
                                  ButtonStyle="ButtonStyle.Light" 
                                  Size="ButtonSize.Small"
                                  Click="@CopyToClipboard"
                                  title="Copy to clipboard" />
                }
                @if (ShowFullscreenButton)
                {
                    <RadzenButton Icon="@(_isFullscreen ? "fullscreen_exit" : "fullscreen")" 
                                  ButtonStyle="ButtonStyle.Light" 
                                  Size="ButtonSize.Small"
                                  Click="@ToggleFullscreen"
                                  title="Toggle fullscreen" />
                }
            </div>
        </div>

        <div class="viewer-content @(_isFullscreen ? "fullscreen" : "")">
            @if (Artifact.Type == ArtifactType.VisualAssetPack)
            {
                <pre class="json-content">@FormatJson(Artifact.Content)</pre>
            }
            else
            {
                @((MarkupString)RenderMarkdown(Artifact.Content))
            }
        </div>
    }
</div>

<style>
    .artifact-viewer {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .empty-viewer {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        color: var(--rz-text-tertiary-color);
    }

    .viewer-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background: var(--rz-base-200);
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .toolbar-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .toolbar-right {
        display: flex;
        gap: 0.5rem;
    }

    .word-count {
        font-size: 0.85rem;
        color: var(--rz-text-tertiary-color);
    }

    .viewer-content {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background: var(--rz-base-background-color);
        border: 1px solid var(--rz-border-color);
        border-radius: 8px;
        max-height: 600px;
    }

    .viewer-content.fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        max-height: none;
        z-index: 1000;
        border-radius: 0;
    }

    .viewer-content h1 {
        font-size: 1.75rem;
        border-bottom: 2px solid var(--rz-border-color);
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .viewer-content h2 {
        font-size: 1.35rem;
        color: var(--rz-primary);
        margin-top: 2rem;
        margin-bottom: 1rem;
    }

    .viewer-content h3 {
        font-size: 1.15rem;
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
    }

    .viewer-content p {
        line-height: 1.7;
        margin-bottom: 1rem;
    }

    .viewer-content ul, .viewer-content ol {
        margin-bottom: 1rem;
        padding-left: 1.5rem;
    }

    .viewer-content li {
        line-height: 1.6;
        margin-bottom: 0.5rem;
    }

    .viewer-content pre {
        background: var(--rz-base-200);
        border-radius: 6px;
        padding: 1rem;
        overflow-x: auto;
        margin-bottom: 1rem;
    }

    .viewer-content code {
        background: var(--rz-base-200);
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-size: 0.9em;
    }

    .viewer-content pre code {
        background: none;
        padding: 0;
    }

    .viewer-content table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
    }

    .viewer-content th, .viewer-content td {
        border: 1px solid var(--rz-border-color);
        padding: 0.75rem;
        text-align: left;
    }

    .viewer-content th {
        background: var(--rz-base-200);
        font-weight: 600;
    }

    .viewer-content blockquote {
        border-left: 4px solid var(--rz-primary);
        padding-left: 1rem;
        margin: 1rem 0;
        color: var(--rz-text-secondary-color);
        font-style: italic;
    }

    .json-content {
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.85rem;
        white-space: pre-wrap;
        word-break: break-word;
    }
</style>

@code {
    /// <summary>
    /// The artifact to display.
    /// </summary>
    [Parameter]
    public ArtifactResponseDto? Artifact { get; set; }

    /// <summary>
    /// Whether to show the copy to clipboard button.
    /// </summary>
    [Parameter]
    public bool ShowCopyButton { get; set; } = true;

    /// <summary>
    /// Whether to show the fullscreen toggle button.
    /// </summary>
    [Parameter]
    public bool ShowFullscreenButton { get; set; } = true;

    [Inject]
    private NotificationService NotificationService { get; set; } = default!;

    private bool _isFullscreen;

    private static readonly MarkdownPipeline _markdownPipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions()
        .Build();

    private string RenderMarkdown(string content)
    {
        try
        {
            return Markdown.ToHtml(content, _markdownPipeline);
        }
        catch
        {
            return $"<pre>{System.Net.WebUtility.HtmlEncode(content)}</pre>";
        }
    }

    private static string FormatJson(string json)
    {
        try
        {
            var doc = System.Text.Json.JsonDocument.Parse(json);
            return System.Text.Json.JsonSerializer.Serialize(doc, new System.Text.Json.JsonSerializerOptions 
            { 
                WriteIndented = true 
            });
        }
        catch
        {
            return json;
        }
    }

    private int GetWordCount()
    {
        if (Artifact is null) return 0;
        return Artifact.Content.Split(new[] { ' ', '\n', '\r', '\t' }, StringSplitOptions.RemoveEmptyEntries).Length;
    }

    private BadgeStyle GetBadgeStyle() => Artifact?.Type switch
    {
        ArtifactType.PRD => BadgeStyle.Success,
        ArtifactType.TechnicalDeepDive => BadgeStyle.Info,
        ArtifactType.VisualAssetPack => BadgeStyle.Secondary,
        _ => BadgeStyle.Light
    };

    private void ToggleFullscreen()
    {
        _isFullscreen = !_isFullscreen;
        StateHasChanged();
    }

    private async Task CopyToClipboard()
    {
        if (Artifact is null) return;

        // Note: In a real implementation, you'd use JS interop for clipboard access
        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Info,
            Summary = "Copy to Clipboard",
            Detail = "Content copied! (Use browser's native copy for full support)",
            Duration = 3000
        });
    }
}

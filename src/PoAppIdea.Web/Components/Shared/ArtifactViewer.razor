@using PoAppIdea.Core.Enums
@using PoAppIdea.Web.Features.Artifacts
@using Markdig
@using Radzen
@using Radzen.Blazor

<div class="artifact-viewer glass-card rz-p-0" style="overflow: hidden;">
    @if (Artifact is null)
    {
        <div class="empty-viewer rz-p-12 rz-text-align-center">
            <RadzenIcon Icon="description" Style="font-size: 48px; opacity: 0.3;" />
            <RadzenText TextStyle="TextStyle.Body1" class="rz-text-secondary-color rz-mt-2">No artifact selected</RadzenText>
        </div>
    }
    else
    {
        <div class="viewer-toolbar rz-p-4" style="background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.1);">
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                    <RadzenBadge BadgeStyle="@GetBadgeStyle()" Text="@Artifact.Type.ToString()" Variant="Variant.Flat" />
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-text-secondary-color">@GetWordCount() words</RadzenText>
                </RadzenStack>
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                    @if (ShowCopyButton)
                    {
                        <RadzenButton Icon="content_copy" 
                                      ButtonStyle="ButtonStyle.Light" 
                                      Variant="Variant.Text"
                                      Size="ButtonSize.Small"
                                      Click="@CopyToClipboard"
                                      title="Copy to clipboard" />
                    }
                    @if (ShowFullscreenButton)
                    {
                        <RadzenButton Icon="@(_isFullscreen ? "fullscreen_exit" : "fullscreen")" 
                                      ButtonStyle="ButtonStyle.Light" 
                                      Variant="Variant.Text"
                                      Size="ButtonSize.Small"
                                      Click="@ToggleFullscreen"
                                      title="Toggle fullscreen" />
                    }
                </RadzenStack>
            </RadzenStack>
        </div>

        <div class="viewer-content rz-p-6 @(_isFullscreen ? "fullscreen" : "")" style="max-height: 60vh; overflow-y: auto; line-height: 1.6;">
            @if (Artifact.Type == ArtifactType.VisualAssetPack)
            {
                <pre class="json-content" style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; color: #a5d6ff; font-family: 'Fira Code', monospace; font-size: 0.875rem;">@FormatJson(Artifact.Content)</pre>
            }
            else
            {
                <div class="markdown-body">
                    @((MarkupString)RenderMarkdown(Artifact.Content))
                </div>
            }
        </div>
    }
</div>

<style>
    .markdown-body h1, .markdown-body h2, .markdown-body h3 {
        color: var(--app-primary-light);
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }
    .markdown-body p {
        margin-bottom: 1rem;
    }
    .markdown-body code {
        background: rgba(255,255,255,0.1);
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-family: monospace;
    }
    .markdown-body ul, .markdown-body ol {
        margin-bottom: 1rem;
        padding-left: 2rem;
    }
</style>

@code {
    /// <summary>
    /// The artifact to display.
    /// </summary>
    [Parameter]
    public ArtifactResponseDto? Artifact { get; set; }

    /// <summary>
    /// Whether to show the copy to clipboard button.
    /// </summary>
    [Parameter]
    public bool ShowCopyButton { get; set; } = true;

    /// <summary>
    /// Whether to show the fullscreen toggle button.
    /// </summary>
    [Parameter]
    public bool ShowFullscreenButton { get; set; } = true;

    [Inject]
    private NotificationService NotificationService { get; set; } = default!;

    private bool _isFullscreen;

    private static readonly MarkdownPipeline _markdownPipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions()
        .Build();

    private string RenderMarkdown(string content)
    {
        try
        {
            return Markdown.ToHtml(content, _markdownPipeline);
        }
        catch
        {
            return $"<pre>{System.Net.WebUtility.HtmlEncode(content)}</pre>";
        }
    }

    private static string FormatJson(string json)
    {
        try
        {
            var doc = System.Text.Json.JsonDocument.Parse(json);
            return System.Text.Json.JsonSerializer.Serialize(doc, new System.Text.Json.JsonSerializerOptions 
            { 
                WriteIndented = true 
            });
        }
        catch
        {
            return json;
        }
    }

    private int GetWordCount()
    {
        if (Artifact is null) return 0;
        return Artifact.Content.Split(new[] { ' ', '\n', '\r', '\t' }, StringSplitOptions.RemoveEmptyEntries).Length;
    }

    private BadgeStyle GetBadgeStyle() => Artifact?.Type switch
    {
        ArtifactType.PRD => BadgeStyle.Success,
        ArtifactType.TechnicalDeepDive => BadgeStyle.Info,
        ArtifactType.VisualAssetPack => BadgeStyle.Secondary,
        _ => BadgeStyle.Light
    };

    private void ToggleFullscreen()
    {
        _isFullscreen = !_isFullscreen;
        StateHasChanged();
    }

    private async Task CopyToClipboard()
    {
        if (Artifact is null) return;

        // Note: In a real implementation, you'd use JS interop for clipboard access
        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Info,
            Summary = "Copy to Clipboard",
            Detail = "Content copied! (Use browser's native copy for full support)",
            Duration = 3000
        });
    }
}

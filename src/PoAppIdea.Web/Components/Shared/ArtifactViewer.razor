@using PoAppIdea.Core.Enums
@using PoAppIdea.Web.Features.Artifacts
@using Markdig
@using Radzen
@using Radzen.Blazor

<div class="artifact-viewer">
    @if (Artifact is null)
    {
        <div class="empty-viewer">
            <p>No artifact selected</p>
        </div>
    }
    else
    {
        <div class="viewer-toolbar">
            <div class="toolbar-left">
                <RadzenBadge BadgeStyle="@GetBadgeStyle()" Text="@Artifact.Type.ToString()" />
                <span class="word-count">@GetWordCount() words</span>
            </div>
            <div class="toolbar-right">
                @if (ShowCopyButton)
                {
                    <RadzenButton Icon="content_copy" 
                                  ButtonStyle="ButtonStyle.Light" 
                                  Size="ButtonSize.Small"
                                  Click="@CopyToClipboard"
                                  title="Copy to clipboard" />
                }
                @if (ShowFullscreenButton)
                {
                    <RadzenButton Icon="@(_isFullscreen ? "fullscreen_exit" : "fullscreen")" 
                                  ButtonStyle="ButtonStyle.Light" 
                                  Size="ButtonSize.Small"
                                  Click="@ToggleFullscreen"
                                  title="Toggle fullscreen" />
                }
            </div>
        </div>

        <div class="viewer-content @(_isFullscreen ? "fullscreen" : "")">
            @if (Artifact.Type == ArtifactType.VisualAssetPack)
            {
                <pre class="json-content">@FormatJson(Artifact.Content)</pre>
            }
            else
            {
                @((MarkupString)RenderMarkdown(Artifact.Content))
            }
        </div>
    }
</div>

@code {
    /// <summary>
    /// The artifact to display.
    /// </summary>
    [Parameter]
    public ArtifactResponseDto? Artifact { get; set; }

    /// <summary>
    /// Whether to show the copy to clipboard button.
    /// </summary>
    [Parameter]
    public bool ShowCopyButton { get; set; } = true;

    /// <summary>
    /// Whether to show the fullscreen toggle button.
    /// </summary>
    [Parameter]
    public bool ShowFullscreenButton { get; set; } = true;

    [Inject]
    private NotificationService NotificationService { get; set; } = default!;

    private bool _isFullscreen;

    private static readonly MarkdownPipeline _markdownPipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions()
        .Build();

    private string RenderMarkdown(string content)
    {
        try
        {
            return Markdown.ToHtml(content, _markdownPipeline);
        }
        catch
        {
            return $"<pre>{System.Net.WebUtility.HtmlEncode(content)}</pre>";
        }
    }

    private static string FormatJson(string json)
    {
        try
        {
            var doc = System.Text.Json.JsonDocument.Parse(json);
            return System.Text.Json.JsonSerializer.Serialize(doc, new System.Text.Json.JsonSerializerOptions 
            { 
                WriteIndented = true 
            });
        }
        catch
        {
            return json;
        }
    }

    private int GetWordCount()
    {
        if (Artifact is null) return 0;
        return Artifact.Content.Split(new[] { ' ', '\n', '\r', '\t' }, StringSplitOptions.RemoveEmptyEntries).Length;
    }

    private BadgeStyle GetBadgeStyle() => Artifact?.Type switch
    {
        ArtifactType.PRD => BadgeStyle.Success,
        ArtifactType.TechnicalDeepDive => BadgeStyle.Info,
        ArtifactType.VisualAssetPack => BadgeStyle.Secondary,
        _ => BadgeStyle.Light
    };

    private void ToggleFullscreen()
    {
        _isFullscreen = !_isFullscreen;
        StateHasChanged();
    }

    private async Task CopyToClipboard()
    {
        if (Artifact is null) return;

        // Note: In a real implementation, you'd use JS interop for clipboard access
        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Info,
            Summary = "Copy to Clipboard",
            Detail = "Content copied! (Use browser's native copy for full support)",
            Duration = 3000
        });
    }
}

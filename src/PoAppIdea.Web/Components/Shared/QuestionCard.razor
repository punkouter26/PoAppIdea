@using PoAppIdea.Web.Features.Refinement

<div class="question-card @(_isExpanded ? "expanded" : "") @(Question.IsAnswered ? "answered" : "")">
    <div class="question-header" @onclick="ToggleExpand">
        <div class="question-number">
            @if (Question.IsAnswered || !string.IsNullOrWhiteSpace(Answer))
            {
                <RadzenIcon Icon="check_circle" Style="color: var(--rz-success);" />
            }
            else
            {
                <span class="number-badge">@Question.QuestionNumber</span>
            }
        </div>
        <div class="question-text">
            <p>@Question.QuestionText</p>
        </div>
        <div class="expand-icon">
            <RadzenIcon Icon="@(_isExpanded ? "expand_less" : "expand_more")" />
        </div>
    </div>

    @if (_isExpanded)
    {
        <div class="question-body">
            <div class="example-section">
                <span class="example-label">Example answer:</span>
                <p class="example-text">@Question.ExampleAnswer</p>
            </div>

            <div class="answer-section">
                <RadzenTextArea 
                    @bind-Value="@_localAnswer"
                    Placeholder="Type your answer here... (1-2000 characters)"
                    Rows="4"
                    MaxLength="2000"
                    Style="width: 100%;"
                    Change="@OnAnswerChange" />
                <div class="char-count @(_localAnswer?.Length > 1800 ? "warning" : "")">
                    @(_localAnswer?.Length ?? 0) / 2000 characters
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public required RefinementQuestionDto Question { get; set; }

    [Parameter]
    public EventCallback<string> OnAnswerChanged { get; set; }

    [Parameter]
    public string Answer { get; set; } = string.Empty;

    private bool _isExpanded;
    private string? _localAnswer;

    protected override void OnParametersSet()
    {
        _localAnswer = Answer;
        
        // Auto-expand if not answered
        if (!Question.IsAnswered && string.IsNullOrWhiteSpace(_localAnswer))
        {
            _isExpanded = false; // Start collapsed, user can expand
        }
    }

    private void ToggleExpand()
    {
        _isExpanded = !_isExpanded;
    }

    private async Task OnAnswerChange()
    {
        await OnAnswerChanged.InvokeAsync(_localAnswer ?? string.Empty);
    }
}

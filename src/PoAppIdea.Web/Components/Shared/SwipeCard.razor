@using PoAppIdea.Shared.Contracts
@using Radzen.Blazor
@inject IJSRuntime JSRuntime
@inject Radzen.NotificationService NotificationService

<div class="swipe-card @swipeClass">
    <RadzenCard class="swipe-card-inner" style="background: var(--gradient-card);">
        <RadzenStack Gap="1.5rem">
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Start">
                <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H2" style="font-weight: 800; color: white;">
                    @Idea.Title
                </RadzenText>
                <div class="caption">ID: @Idea.Id.ToString().Substring(0, 4)</div>
            </RadzenStack>

            <RadzenText TextStyle="TextStyle.Body1" style="color: var(--text-secondary); line-height: 1.6;">
                @Idea.Description
            </RadzenText>

            <div class="dna-keywords">
                @foreach (var keyword in Idea.DnaKeywords.Take(4))
                {
                    <span class="dna-keyword">#@keyword.ToLower()</span>
                }
            </div>

            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" class="rz-mt-2">
                <RadzenBadge BadgeStyle="BadgeStyle.Primary" IsPill="true" class="rz-px-4">
                    Score: @Idea.Score.ToString("F1")
                </RadzenBadge>
            </RadzenStack>

            <!-- Simplified button-based actions -->
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Center" Gap="0.5rem" class="rz-mt-4">
                <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Large" 
                              Variant="Variant.Filled" Click="@(() => HandleButtonSwipe(SwipeDirection.Left))"
                              aria-label="Skip" title="Skip (Left)" />
                <RadzenButton Icon="auto_awesome" ButtonStyle="ButtonStyle.Secondary" Size="ButtonSize.Large"
                              Variant="Variant.Filled" Click="@(() => HandleButtonSwipe(SwipeDirection.Up))"
                              aria-label="Super Like" title="Super Like (Up)" />
                <RadzenButton Icon="favorite" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Large"
                              Variant="Variant.Filled" Click="@(() => HandleButtonSwipe(SwipeDirection.Right))"
                              aria-label="Like" title="Like (Right)" />
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>
</div>

@code {
    [Parameter]
    public required IdeaDto Idea { get; set; }

    [Parameter]
    public EventCallback<SwipeResult> OnSwiped { get; set; }

    private string swipeClass = "";
    private DateTime actionStartTime = DateTime.UtcNow;

    private async Task HandleButtonSwipe(SwipeDirection direction)
    {
        var duration = (int)(DateTime.UtcNow - actionStartTime).TotalMilliseconds;
        actionStartTime = DateTime.UtcNow;

        swipeClass = direction switch
        {
            SwipeDirection.Right => "swiping-right",
            SwipeDirection.Up => "swiping-up",
            _ => "swiping-left"
        };

        var message = direction switch
        {
            SwipeDirection.Right => "Saved to Session",
            SwipeDirection.Up => "Super Liked! ðŸ”¥",
            _ => "Skipped"
        };

        var severity = direction switch
        {
            SwipeDirection.Right => Radzen.NotificationSeverity.Success,
            SwipeDirection.Up => Radzen.NotificationSeverity.Info,
            _ => Radzen.NotificationSeverity.Warning
        };

        // Show Radzen notification instead of custom whisper
        NotificationService.Notify(severity, message, duration: 2000);

        await OnSwiped.InvokeAsync(new SwipeResult
        {
            IdeaId = Idea.Id,
            Direction = direction,
            DurationMs = duration
        });

        // Reset animation class after delay
        await Task.Delay(300);
        swipeClass = "";
    }

    public enum SwipeDirection
    {
        Left,
        Right,
        Up
    }

    public record SwipeResult
    {
        public Guid IdeaId { get; init; }
        public SwipeDirection Direction { get; init; }
        public int DurationMs { get; init; }
    }
}

@using PoAppIdea.Shared.Contracts

<div class="swipe-card @swipeClass" 
     @onmousedown="StartDrag"
     @onmousemove="Drag"
     @onmouseup="EndDrag"
     @onmouseleave="EndDrag"
     @ontouchstart="StartTouchDrag"
     @ontouchmove="TouchDrag"
     @ontouchend="EndDrag"
     style="transform: translateX(@(offsetX)px) rotate(@(rotation)deg); @(isDragging ? "" : "transition: transform 0.3s ease;")">
    
    <RadzenCard class="swipe-card-inner">
        <RadzenStack Gap="1rem">
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Start">
                <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H2">
                    @Idea.Title
                </RadzenText>
                <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@($"Batch {Idea.BatchNumber}")" />
            </RadzenStack>

            <RadzenText TextStyle="TextStyle.Body1">
                @Idea.Description
            </RadzenText>

            <RadzenStack Orientation="Orientation.Horizontal" Wrap="FlexWrap.Wrap" Gap="0.5rem">
                @foreach (var keyword in Idea.DnaKeywords.Take(5))
                {
                    <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="@keyword" />
                }
            </RadzenStack>

            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" class="rz-mt-2">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-text-secondary-color">
                    Score: @Idea.Score.ToString("F1")
                </RadzenText>
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>

    @if (offsetX > SwipeThreshold)
    {
        <div class="swipe-indicator like">
            <RadzenIcon Icon="favorite" />
        </div>
    }
    else if (offsetX < -SwipeThreshold)
    {
        <div class="swipe-indicator nope">
            <RadzenIcon Icon="close" />
        </div>
    }
</div>

@code {
    [Parameter]
    public required IdeaDto Idea { get; set; }

    [Parameter]
    public EventCallback<SwipeResult> OnSwiped { get; set; }

    private const int SwipeThreshold = 80;
    private const int UpSwipeThreshold = -100;

    private double offsetX = 0;
    private double offsetY = 0;
    private double rotation = 0;
    private double startX = 0;
    private double startY = 0;
    private bool isDragging = false;
    private DateTime dragStartTime;
    private string swipeClass = "";

    private void StartDrag(MouseEventArgs e)
    {
        isDragging = true;
        startX = e.ClientX;
        startY = e.ClientY;
        dragStartTime = DateTime.UtcNow;
    }

    private void StartTouchDrag(TouchEventArgs e)
    {
        if (e.Touches.Length > 0)
        {
            isDragging = true;
            startX = e.Touches[0].ClientX;
            startY = e.Touches[0].ClientY;
            dragStartTime = DateTime.UtcNow;
        }
    }

    private void Drag(MouseEventArgs e)
    {
        if (!isDragging) return;

        offsetX = e.ClientX - startX;
        offsetY = e.ClientY - startY;
        rotation = offsetX * 0.1; // Subtle rotation effect
    }

    private void TouchDrag(TouchEventArgs e)
    {
        if (!isDragging || e.Touches.Length == 0) return;

        offsetX = e.Touches[0].ClientX - startX;
        offsetY = e.Touches[0].ClientY - startY;
        rotation = offsetX * 0.1;
    }

    private async Task EndDrag()
    {
        if (!isDragging) return;
        isDragging = false;

        var duration = (int)(DateTime.UtcNow - dragStartTime).TotalMilliseconds;

        if (offsetY < UpSwipeThreshold)
        {
            // Super like (swipe up)
            swipeClass = "swiping-up";
            await NotifySwipe(SwipeDirection.Up, duration);
        }
        else if (offsetX > SwipeThreshold)
        {
            // Like (swipe right)
            swipeClass = "swiping-right";
            await NotifySwipe(SwipeDirection.Right, duration);
        }
        else if (offsetX < -SwipeThreshold)
        {
            // Nope (swipe left)
            swipeClass = "swiping-left";
            await NotifySwipe(SwipeDirection.Left, duration);
        }
        else
        {
            // Reset position
            offsetX = 0;
            offsetY = 0;
            rotation = 0;
        }
    }

    private async Task NotifySwipe(SwipeDirection direction, int durationMs)
    {
        await OnSwiped.InvokeAsync(new SwipeResult
        {
            IdeaId = Idea.Id,
            Direction = direction,
            DurationMs = durationMs
        });

        // Reset after animation
        await Task.Delay(300);
        offsetX = 0;
        offsetY = 0;
        rotation = 0;
        swipeClass = "";
    }

    public enum SwipeDirection
    {
        Left,
        Right,
        Up
    }

    public record SwipeResult
    {
        public Guid IdeaId { get; init; }
        public SwipeDirection Direction { get; init; }
        public int DurationMs { get; init; }
    }
}
